/*
wm.js (C) acdra1n 2020. Licensed under GNU GPLv3.
*/

"use strict";function _instanceof(a,b){return null!=b&&"undefined"!=typeof Symbol&&b[Symbol.hasInstance]?!!b[Symbol.hasInstance](a):a instanceof b}function _classCallCheck(a,b){if(!_instanceof(a,b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(a){'use strict';if(null===a||a===void 0)throw new TypeError("Cannot convert undefined or null to object");for(var b,c=Object(a),d=1;d<arguments.length;d++)if(b=arguments[d],null!==b&&void 0!==b)for(var e in b)Object.prototype.hasOwnProperty.call(b,e)&&(c[e]=b[e]);return c},writable:!0,configurable:!0});var WMJS=function(){var a=function(){var a=null,b={x:0,y:0};return window.onload=function(){document.body.addEventListener("mouseup",function(){var b;if(a){var c=a.getBoundingClientRect();null===(b=a._drag.ondragend)||void 0===b?void 0:b.call(a._drag,a,{x:c.x+"px",y:c.y+"px"}),a=null}}),document.body.addEventListener("mousemove",function(c){var d;if(a){var e=c.x-b.x+"px",f=c.y-b.y+"px";null===(d=a._drag.ondrag)||void 0===d?void 0:d.call(a._drag,a,{x:e,y:f}),a.style.left=e,a.style.top=f}})},{draggable:function(c,d){if("destroy"==d)return c._drag?(c.removeEventListener("mousedown",c._drag._evt_mousedown),void delete c._drag):void 0;if(!c._drag){var f={};Object.assign(f,{ondragstart:null,ondrag:null,ondragend:null,cancel:""},d),f.cancel=f.cancel.split(","),f._evt_mousedown=function(d){for(var e,g=0;g<f.cancel.length;g++)for(var h=f.cancel[g],j=d.target;null!=j;){if(j.matches(h))return;j=j.parentElement}var k=d.target.getBoundingClientRect(),l=d.clientX-k.left,m=d.clientY-k.top;b={x:l,y:m},a=c,null===(e=f.ondragstart)||void 0===e?void 0:e.call(f,c,{rx:l+"px",ry:m+"px"})},c._drag=f,c.addEventListener("mousedown",f._evt_mousedown)}}}}(),b=function(){function b(a){_classCallCheck(this,b),this.baseElement=document.createElement("div"),this.registered=!1,this.shown=!1,this.maximized=!1,this.wm=a,this.id=0,this.onopen=function(){},this.onclose=function(){},this.onshown=function(){},this.onmaximize=function(){},this.onminimize=function(){},this.onrestore=function(){},this.onactivate=function(){},this.ondeactivate=function(){}}return _createClass(b,[{key:"_createWindow",value:function(a){var b=this;this.baseElement.classList.add("wm-window"),this.baseElement.style.zIndex=this.wm.zIndexStartOffset+this.id+1;var c=document.createElement("div");c.classList.add("titlebar");var d=document.createElement("span");d.classList.add("title");var e=document.createElement("div");e.classList.add("control-box"),e.insertAdjacentHTML("beforeend","<button role=\"minimize\">\u2500</button>"+(a.resizable?"<button role=\"maximize\">\u25A2</button>":"")+"<button role=\"close\">\u2715</button>"),a.resizable&&(d.addEventListener("dblclick",function(){b.toggleMaximize()}),e.querySelector("button[role=\"maximize\"]").addEventListener("click",function(){b.toggleMaximize()}),e.querySelector("button[role=\"minimize\"]").addEventListener("click",function(){var a;b.hide(),null===(a=b.onminimize)||void 0===a?void 0:a.call()}),e.querySelector("button[role=\"close\"]").addEventListener("click",function(){var a;null===(a=b.onclose)||void 0===a?void 0:a.call(),b.close()})),c.appendChild(d),c.appendChild(e);var f=document.createElement("div");f.classList.add("content"),this.baseElement.style.position="absolute",this.baseElement.style.height="string"==typeof a.height?a.height:a.height+"px",this.baseElement.style.width="string"==typeof a.width?a.width:a.width+"px",this.baseElement.style.left="string"==typeof a.x?a.x:a.x+"px",this.baseElement.style.top="string"==typeof a.y?a.y:a.y+"px",d.innerText=a.title,this.baseElement.appendChild(c),this.baseElement.appendChild(f),this.baseElement.addEventListener("mousedown",function(){b.activate()}),a.draggable&&this.setDraggable()}},{key:"_registerWindow",value:function(){this.wm.container.appendChild(this.baseElement),this.registered=!0}},{key:"setDraggable",value:function(){var b=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];b?a.draggable(this.baseElement,{cancel:".content,.control-box,.ui-resizable-handle"}):a.draggable(this.baseElement,"destroy")}},{key:"toggleMaximize",value:function(){if(!this.maximized){var a;this._ogBounds={height:this.baseElement.style.height,width:this.baseElement.style.width,x:this.baseElement.style.left,y:this.baseElement.style.top},this.baseElement.style.height="100%",this.baseElement.style.width="100%",this.baseElement.style.left="0px",this.baseElement.style.top="0px",this.baseElement.classList.add("maximized"),this.maximized=!0,this.setDraggable(!1),null===(a=this.onmaximize)||void 0===a?void 0:a.call()}else{var b;this.baseElement.style.height=this._ogBounds.height,this.baseElement.style.width=this._ogBounds.width,this.baseElement.style.left=this._ogBounds.x,this.baseElement.style.top=this._ogBounds.y,this.baseElement.classList.remove("maximized"),this.maximized=!1,this.setDraggable(!0),null===(b=this.onrestore)||void 0===b?void 0:b.call()}}},{key:"getWindowRect",value:function(){var a=this.baseElement.getBoundingClientRect();return{x:a.x,y:a.y,height:a.height,width:a.width}}},{key:"getContentContainer",value:function(){return this.baseElement.querySelector(".content")}},{key:"activate",value:function(){var a;this.baseElement.classList.contains("active")||(this.wm.activate(this),null===(a=this.onactivate)||void 0===a?void 0:a.call())}},{key:"show",value:function(){var a;if(!this.shown){if(!this.registered){var b;this._registerWindow(),null===(b=this.onopen)||void 0===b?void 0:b.call()}this.baseElement.style.display="flex",this.shown=!0,null===(a=this.onshown)||void 0===a?void 0:a.call(),this.activate()}}},{key:"hide",value:function(){this.shown&&(this.baseElement.style.display="none",this.shown=!1)}},{key:"close",value:function(){this.wm.destroy(this)}}]),b}(),c=function(){function a(b){if(_classCallCheck(this,a),_instanceof(b,HTMLElement)||(b=document.querySelector(b)),!b)throw new Error("The specified container element is not valid.");if(b._wm)throw new Error("The specified container already has a window manager.");this.container=b,this.windows=[],this.zIndexStartOffset=10,this._createdWindows=0,b._wm={}}return _createClass(a,[{key:"createWindow",value:function(a){var c={};Object.assign(c,{title:"Untitled",height:315,width:450,x:10,y:10,resizable:!0,draggable:!0},a);var d=new b(this,c);return d.id=this._createdWindows++,d._createWindow(c),this.windows.push(d),d}},{key:"findWindow",value:function(a){return this.windows.find(function(b){return(null===b||void 0===b?void 0:b.id)==a})}},{key:"destroyAll",value:function(){var a=this;this.windows.forEach(function(b,c){a.container.removeChild(b.baseElement),b.wm=null,b.baseElement=null,a.windows[c]=null,delete a.windows[c]})}},{key:"destroy",value:function(a){var c=_instanceof(a,b)?a:this.findWindow(a);if(c.wm){this.container.removeChild(c.baseElement),c.baseElement=null;var d=this.windows.indexOf(c);this.windows[d]=null,delete this.windows[d]}}},{key:"activate",value:function(a){var c=_instanceof(a,b)?a:this.findWindow(a),d=parseInt(c.baseElement.style.zIndex);this.windows.forEach(function(b,e,f){if(null!=f[e]&&f[e].id!=c.id){if(f[e].baseElement.classList.contains("active")){var a;f[e].baseElement.classList.remove("active"),null===(a=f[e].ondeactivate)||void 0===a?void 0:a.call()}var g=parseInt(b.baseElement.style.zIndex);g>d&&(d=g)}}),c.baseElement.style.zIndex=d+1,c.baseElement.classList.add("active")}}]),a}();return{WindowManager:c,util:a}}();window.WMJS=WMJS;